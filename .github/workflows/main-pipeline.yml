name: Archer CI/CD Pipeline

on:
  workflow_dispatch:
  schedule:
    # 6:00 PM EST = 23:00 UTC
    - cron: '0 23 * * *'

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  # ====================================================
  # JOB 1: PROVISION & DETECT STACK
  # ====================================================
  provision-stack:
    name: Provision Stack
    runs-on: ubuntu-latest
    outputs:
      fe_provider: ${{ steps.parse.outputs.fe_provider }}
      project_name: ${{ steps.parse.outputs.project_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Parse stack.json
        id: parse
        run: |
          echo "fe_provider=$(jq -r '.frontend.provider' setup/stack.json)" >> $GITHUB_OUTPUT
          echo "project_name=$(jq -r '.project_name' setup/stack.json)" >> $GITHUB_OUTPUT

  # ====================================================
  # JOB 2: RESOLVE STAGING URL
  # ====================================================
  resolve-staging:
    name: Resolve Staging URL
    needs: provision-stack
    runs-on: ubuntu-latest
    outputs:
      staging_url: ${{ steps.set-url.outputs.staging_url }}
    steps:
      - id: set-url
        run: echo "staging_url=https://amd1-1-beta.vercel.app" >> $GITHUB_OUTPUT

  # ====================================================
  # JOBS 3a-3e: TEST AGENTS (PARALLEL)
  #
  # Reporter note: DO NOT pass --reporter on the CLI.
  # playwright.config.ts auto-detects CI and uses both
  # "list" (visible output) + "html" (artifact report).
  # Overriding with --reporter=html hides all log output.
  # ====================================================

  test-functional:
    name: "Agent 1: Functional"
    needs: resolve-staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - name: Run functional tests
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ needs.resolve-staging.outputs.staging_url }}
          BASE_URL: ${{ needs.resolve-staging.outputs.staging_url }}
          HOME: /root
          NEXT_PUBLIC_SKIP_LOADING_DELAY: 'true'
        run: |
          echo "────────────────────────────────────────"
          echo "  AGENT 1: FUNCTIONAL TESTS"
          echo "  Target: $PLAYWRIGHT_TEST_BASE_URL"
          echo "  Files: wizard-flow, enrichment, executive-review"
          echo "────────────────────────────────────────"
          npx playwright test \
            tests/e2e/wizard-flow.spec.ts \
            tests/e2e/enrichment.spec.ts \
            tests/e2e/executive-review.spec.ts
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-functional
          path: playwright-report/
          retention-days: 14

  test-security:
    name: "Agent 2: Security"
    needs: resolve-staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - name: Run security tests
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ needs.resolve-staging.outputs.staging_url }}
          BASE_URL: ${{ needs.resolve-staging.outputs.staging_url }}
          HOME: /root
          NEXT_PUBLIC_SKIP_LOADING_DELAY: 'true'
        run: |
          echo "────────────────────────────────────────"
          echo "  AGENT 2: SECURITY AUDIT"
          echo "  Target: $PLAYWRIGHT_TEST_BASE_URL"
          echo "────────────────────────────────────────"
          npx playwright test tests/e2e/security-audit.spec.ts
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-security
          path: playwright-report/
          retention-days: 14

  test-chaos:
    name: "Agent 3: Chaos"
    needs: resolve-staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - name: Run chaos tests
        continue-on-error: true
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ needs.resolve-staging.outputs.staging_url }}
          BASE_URL: ${{ needs.resolve-staging.outputs.staging_url }}
          HOME: /root
          NEXT_PUBLIC_SKIP_LOADING_DELAY: 'true'
        run: |
          echo "────────────────────────────────────────"
          echo "  AGENT 3: CHAOS AGENT"
          echo "  Target: $PLAYWRIGHT_TEST_BASE_URL"
          echo "────────────────────────────────────────"
          npx playwright test tests/e2e/chaos-agent.spec.ts
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-chaos
          path: playwright-report/
          retention-days: 14

  test-accessibility:
    name: "Agent 4: Accessibility"
    needs: resolve-staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - name: Run accessibility tests
        continue-on-error: true
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ needs.resolve-staging.outputs.staging_url }}
          BASE_URL: ${{ needs.resolve-staging.outputs.staging_url }}
          HOME: /root
          NEXT_PUBLIC_SKIP_LOADING_DELAY: 'true'
        run: |
          echo "────────────────────────────────────────"
          echo "  AGENT 4: ACCESSIBILITY"
          echo "  Target: $PLAYWRIGHT_TEST_BASE_URL"
          echo "────────────────────────────────────────"
          npx playwright test tests/e2e/accessibility-agent.spec.ts
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-accessibility
          path: playwright-report/
          retention-days: 14

  test-performance:
    name: "Agent 5: Performance"
    needs: resolve-staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - name: Run performance tests
        continue-on-error: true
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ needs.resolve-staging.outputs.staging_url }}
          BASE_URL: ${{ needs.resolve-staging.outputs.staging_url }}
          HOME: /root
          NEXT_PUBLIC_SKIP_LOADING_DELAY: 'true'
        run: |
          echo "────────────────────────────────────────"
          echo "  AGENT 5: PERFORMANCE"
          echo "  Target: $PLAYWRIGHT_TEST_BASE_URL"
          echo "────────────────────────────────────────"
          npx playwright test tests/e2e/performance-agent.spec.ts
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-performance
          path: playwright-report/
          retention-days: 14

  # ====================================================
  # JOB 4: PROMOTION GATE
  # Only Functional + Security block promotion.
  # Chaos, Accessibility, Performance are advisory.
  # ====================================================
  gate:
    name: Promotion Gate
    needs: [test-functional, test-security, test-chaos, test-accessibility, test-performance]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate agent results
        run: |
          echo ""
          echo "╔══════════════════════════════════════════════╗"
          echo "║          ARCHER TEST AGENT SUMMARY           ║"
          echo "╠══════════════════════════════════════════════╣"
          echo "║  Agent 1 (Functional):     ${{ needs.test-functional.result }}"
          echo "║  Agent 2 (Security):       ${{ needs.test-security.result }}"
          echo "║  Agent 3 (Chaos):          ${{ needs.test-chaos.result }}"
          echo "║  Agent 4 (Accessibility):  ${{ needs.test-accessibility.result }}"
          echo "║  Agent 5 (Performance):    ${{ needs.test-performance.result }}"
          echo "╠══════════════════════════════════════════════╣"
          echo "║  Critical: Functional + Security             ║"
          echo "║  Advisory: Chaos + Accessibility + Perf      ║"
          echo "╚══════════════════════════════════════════════╝"
          echo ""

          FUNC="${{ needs.test-functional.result }}"
          SEC="${{ needs.test-security.result }}"

          if [ "$FUNC" != "success" ] || [ "$SEC" != "success" ]; then
            echo "BLOCKED: Critical agent failure."
            echo "  Functional: $FUNC"
            echo "  Security:   $SEC"
            exit 1
          fi

          echo "All critical agents passed. Promotion allowed."

  # ====================================================
  # JOB 5: PROMOTE TO PRODUCTION
  # Merges beta → main, deploys if secrets configured.
  # ====================================================
  promote-to-prod:
    name: Promote to Production
    needs: [gate, resolve-staging]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ── Create backup tag ──
      - name: Create backup tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="prod-$(date +'%Y-%m-%d-%H%M')-run${{ github.run_number }}"
          gh release create "$TAG" --generate-notes --title "Production $TAG" || echo "Tag skipped"

      # ── Merge beta → main ──
      - name: Promote beta to main
        run: |
          git config user.name 'Archer Pipeline'
          git config user.email 'archer@github-actions.bot'
          git fetch origin beta main
          git checkout main
          git merge origin/beta --no-edit -m "promote: beta → main — Archer run #${{ github.run_number }} [skip ci]" || {
            echo "Merge conflict. Skipping promotion — manual merge required."
            exit 0
          }
          git push origin main
          echo "Beta merged into main."

      # ── Deploy frontend to production Vercel (if secrets available) ──
      - name: Deploy to Vercel production
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -z "$VERCEL_TOKEN" ] || [ -z "$VERCEL_PROJECT_ID" ]; then
            echo "Vercel secrets not configured. Skipping production frontend deploy."
            echo "To enable: add VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID to repo secrets."
            exit 0
          fi

          echo "Triggering Vercel production deployment..."
          RESPONSE=$(curl -s -X POST "https://api.vercel.com/v13/deployments" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"amd1-1\",
              \"project\": \"$VERCEL_PROJECT_ID\",
              \"target\": \"production\",
              \"gitSource\": {
                \"type\": \"github\",
                \"repoId\": \"${{ github.repository_id }}\",
                \"ref\": \"main\"
              }
            }" 2>&1)

          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty' 2>/dev/null)
          if [ -n "$ERROR" ]; then
            echo "Vercel API error: $ERROR"
          else
            URL=$(echo "$RESPONSE" | jq -r '.url // "pending"' 2>/dev/null)
            echo "Production deployment triggered: $URL"
          fi

      # ── Deploy backend to Render (if hook available) ──
      - name: Deploy to Render
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "Render deploy hook not configured. Skipping backend deploy."
            exit 0
          fi
          echo "Triggering Render backend deployment..."
          curl -s "$RENDER_DEPLOY_HOOK" || echo "Render hook failed (non-critical)"

      # ── Auto-close failure issues ──
      - name: Auto-close failure issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUES=$(gh issue list --search "Pipeline FAILED" --state open --json number --jq '.[].number' 2>/dev/null || echo "")
          for NUM in $ISSUES; do
            gh issue close "$NUM" --comment "Resolved: All agents passed in run #${{ github.run_number }}. Beta promoted to main." 2>/dev/null || true
          done

      # ── Create success report ──
      - name: Create success issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > /tmp/success.md << 'EOF'
          ## Archer Pipeline — All Agents Passed

          | Field | Value |
          |-------|-------|
          | **Date** | PIPELINE_DATE |
          | **Tested URL** | PIPELINE_URL |
          | **Action** | beta merged → main |
          | **Run** | [View logs](PIPELINE_RUN_URL) |

          ---

          ### Agent Results

          | # | Agent | Role | Tests | Status |
          |---|-------|------|-------|--------|
          | 1 | Functional | Critical | 23 | PASS |
          | 2 | Security | Critical | 11 | PASS |
          | 3 | Chaos | Advisory | 12 | PASS |
          | 4 | Accessibility | Advisory | 11 | PASS |
          | 5 | Performance | Advisory | 10 | PASS |

          **67 tests** across 5 agents. No XSS, no secrets exposure, graceful failure handling, within performance budgets.

          ---
          *Auto-created by Archer CI/CD Pipeline*
          EOF

          sed -i "s|PIPELINE_DATE|$(date +'%b %d %Y %H:%M UTC')|g" /tmp/success.md
          sed -i "s|PIPELINE_URL|${{ needs.resolve-staging.outputs.staging_url }}|g" /tmp/success.md
          sed -i "s|PIPELINE_RUN_URL|https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|g" /tmp/success.md

          gh issue create \
            --title "Pipeline PASSED — $(date +'%b %d %Y') — 67 tests, promoted to main" \
            --body-file /tmp/success.md \
            --label "documentation" \
            --assignee "${{ github.repository_owner }}" 2>/dev/null || \
          gh issue create \
            --title "Pipeline PASSED — $(date +'%b %d %Y')" \
            --body-file /tmp/success.md 2>/dev/null || true

  # ====================================================
  # JOB 6: FAILURE REPORT
  # ====================================================
  handle-failure:
    name: Report Failure
    needs: [gate, resolve-staging, test-functional, test-security, test-chaos, test-accessibility, test-performance]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create failure issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > /tmp/failure.md << 'EOF'
          ## Archer Pipeline — Validation Failed

          | Field | Value |
          |-------|-------|
          | **Date** | PIPELINE_DATE |
          | **Tested URL** | PIPELINE_URL |
          | **Run** | [View logs](PIPELINE_RUN_URL) |

          ---

          ### Agent Results

          | # | Agent | Role | Result |
          |---|-------|------|--------|
          | 1 | Functional | Critical | AGENT_FUNC |
          | 2 | Security | Critical | AGENT_SEC |
          | 3 | Chaos | Advisory | AGENT_CHAOS |
          | 4 | Accessibility | Advisory | AGENT_A11Y |
          | 5 | Performance | Advisory | AGENT_PERF |

          ### What Each Agent Tests

          | Agent | Tests | Coverage |
          |-------|-------|----------|
          | **Functional** | 23 | Wizard flow, form validation, enrichment pre-fill, executive review API + rendering, navigation, reset |
          | **Security** | 11 | XSS injection, secrets in DOM/JS, security headers, consent, email injection, localStorage, API field whitelist |
          | **Chaos** | 12 | Slow APIs, timeouts, malformed JSON, empty responses, HTML errors, back/forward, rapid input, race conditions |
          | **Accessibility** | 11 | WCAG 2.1 AA, form labels, Tab nav, keyboard Enter, heading hierarchy, focus indicators, ARIA, duplicate IDs |
          | **Performance** | 10 | Load time, bundle size, request count, DOM nodes, CLS, step transitions, console errors, exceptions |

          ### How to Investigate
          1. Click **View logs** — each agent shows full test output with pass/fail per test
          2. Download `report-*` artifacts for HTML reports with screenshots and traces
          3. Fix failures and push to `beta` — runs nightly at 6pm EST or manually via workflow_dispatch

          ### Promotion Policy
          - **Functional + Security** failure = promotion **blocked**
          - **Chaos + Accessibility + Performance** failure = advisory only

          ---
          *Auto-created by Archer CI/CD Pipeline*
          EOF

          sed -i "s|PIPELINE_DATE|$(date +'%b %d %Y %H:%M UTC')|g" /tmp/failure.md
          sed -i "s|PIPELINE_URL|${{ needs.resolve-staging.outputs.staging_url }}|g" /tmp/failure.md
          sed -i "s|PIPELINE_RUN_URL|https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|g" /tmp/failure.md
          sed -i "s|AGENT_FUNC|${{ needs.test-functional.result }}|g" /tmp/failure.md
          sed -i "s|AGENT_SEC|${{ needs.test-security.result }}|g" /tmp/failure.md
          sed -i "s|AGENT_CHAOS|${{ needs.test-chaos.result }}|g" /tmp/failure.md
          sed -i "s|AGENT_A11Y|${{ needs.test-accessibility.result }}|g" /tmp/failure.md
          sed -i "s|AGENT_PERF|${{ needs.test-performance.result }}|g" /tmp/failure.md

          gh issue create \
            --title "Pipeline FAILED — $(date +'%b %d %Y %H:%M') UTC" \
            --body-file /tmp/failure.md \
            --label "bug" \
            --assignee "${{ github.repository_owner }}" 2>/dev/null || \
          gh issue create \
            --title "Pipeline FAILED — $(date +'%b %d %Y %H:%M') UTC" \
            --body-file /tmp/failure.md 2>/dev/null || true
