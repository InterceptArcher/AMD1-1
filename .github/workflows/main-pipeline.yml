name: Archer CI/CD Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: '0 23 * * *'

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  # ====================================================
  # JOB 1: PROVISION & DETECT STACK
  # ====================================================
  provision-stack:
    name: Provision Stack
    runs-on: ubuntu-latest
    outputs:
      fe_provider: ${{ steps.parse.outputs.fe_provider }}
      project_name: ${{ steps.parse.outputs.project_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Parse stack.json
        id: parse
        run: |
          echo "fe_provider=$(jq -r '.frontend.provider' setup/stack.json)" >> $GITHUB_OUTPUT
          echo "project_name=$(jq -r '.project_name' setup/stack.json)" >> $GITHUB_OUTPUT
      - run: echo "PLACEHOLDER=true" > .env
      - uses: actions/upload-artifact@v4
        with:
          name: supabase-env
          path: .env
          include-hidden-files: true
          retention-days: 1

  # ====================================================
  # JOB 2: RESOLVE TESTING URL
  # ====================================================
  resolve-url:
    name: Resolve Testing URL
    needs: provision-stack
    runs-on: ubuntu-latest
    outputs:
      preview_url: ${{ steps.set-url.outputs.preview_url }}
    steps:
      - id: set-url
        run: echo "preview_url=https://amd1-1-beta.vercel.app" >> $GITHUB_OUTPUT

  # ====================================================
  # JOBS 3a-3e: TEST AGENTS (PARALLEL)
  # ====================================================
  test-functional:
    name: "Agent 1: Functional"
    needs: resolve-url
    runs-on: ubuntu-latest
    timeout-minutes: 10
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - name: Run functional tests
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ needs.resolve-url.outputs.preview_url }}
          BASE_URL: ${{ needs.resolve-url.outputs.preview_url }}
          HOME: /root
        run: npx playwright test tests/e2e/wizard-flow.spec.ts tests/e2e/enrichment.spec.ts tests/e2e/executive-review.spec.ts --reporter=html
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-functional
          path: playwright-report/
          retention-days: 14

  test-security:
    name: "Agent 2: Security"
    needs: resolve-url
    runs-on: ubuntu-latest
    timeout-minutes: 10
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - name: Run security tests
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ needs.resolve-url.outputs.preview_url }}
          BASE_URL: ${{ needs.resolve-url.outputs.preview_url }}
          HOME: /root
        run: npx playwright test tests/e2e/security-audit.spec.ts --reporter=html
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-security
          path: playwright-report/
          retention-days: 14

  test-chaos:
    name: "Agent 3: Chaos"
    needs: resolve-url
    runs-on: ubuntu-latest
    timeout-minutes: 10
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - name: Run chaos tests
        continue-on-error: true
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ needs.resolve-url.outputs.preview_url }}
          BASE_URL: ${{ needs.resolve-url.outputs.preview_url }}
          HOME: /root
        run: npx playwright test tests/e2e/chaos-agent.spec.ts --reporter=html
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-chaos
          path: playwright-report/
          retention-days: 14

  test-accessibility:
    name: "Agent 4: Accessibility"
    needs: resolve-url
    runs-on: ubuntu-latest
    timeout-minutes: 10
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - name: Run accessibility tests
        continue-on-error: true
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ needs.resolve-url.outputs.preview_url }}
          BASE_URL: ${{ needs.resolve-url.outputs.preview_url }}
          HOME: /root
        run: npx playwright test tests/e2e/accessibility-agent.spec.ts --reporter=html
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-accessibility
          path: playwright-report/
          retention-days: 14

  test-performance:
    name: "Agent 5: Performance"
    needs: resolve-url
    runs-on: ubuntu-latest
    timeout-minutes: 10
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - name: Run performance tests
        continue-on-error: true
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ needs.resolve-url.outputs.preview_url }}
          BASE_URL: ${{ needs.resolve-url.outputs.preview_url }}
          HOME: /root
        run: npx playwright test tests/e2e/performance-agent.spec.ts --reporter=html
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-performance
          path: playwright-report/
          retention-days: 14

  # ====================================================
  # JOB 4: GATE — only functional + security block promotion
  # ====================================================
  gate:
    name: Promotion Gate
    needs: [test-functional, test-security, test-chaos, test-accessibility, test-performance]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check critical agents
        run: |
          echo "Functional: ${{ needs.test-functional.result }}"
          echo "Security:   ${{ needs.test-security.result }}"
          echo "Chaos:      ${{ needs.test-chaos.result }}"
          echo "A11y:       ${{ needs.test-accessibility.result }}"
          echo "Perf:       ${{ needs.test-performance.result }}"
          if [[ "${{ needs.test-functional.result }}" != "success" ]] || [[ "${{ needs.test-security.result }}" != "success" ]]; then
            echo "BLOCKED: Functional or Security agent failed."
            exit 1
          fi
          echo "Critical agents passed. Advisory agents logged above."

  # ====================================================
  # JOB 5: PROMOTE TO PROD (only if gate passes)
  # ====================================================
  promote-to-prod:
    name: Promote to Production
    needs: [gate, resolve-url]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create Backup Tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="prod-backup-$(date +'%Y-%m-%d-%H%M%S')-${{ github.run_number }}"
          gh release create "$TAG" --generate-notes --title "Prod Deployment $TAG" || echo "Tag skipped"

      - name: Auto-close failure issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUES=$(gh issue list --search "Pipeline Failure" --state open --json number --jq '.[].number' 2>/dev/null || echo "")
          for NUM in $ISSUES; do
            gh issue close "$NUM" --comment "Resolved: All agents passed in run #${{ github.run_number }}." 2>/dev/null || true
          done

      - name: Log success
        run: echo "All critical agents passed against ${{ needs.resolve-url.outputs.preview_url }}"

  # ====================================================
  # JOB 6: FAILURE REPORT (if gate fails)
  # ====================================================
  handle-failure:
    name: Report Failure
    needs: [gate, resolve-url]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create failure issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY="## Pipeline Failure — $(date)

          **Branch:** ${{ github.ref_name }}
          **URL:** ${{ needs.resolve-url.outputs.preview_url }}
          **Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Download the test report artifacts from the run link above for details."

          gh issue create \
            --title "Pipeline Failure — $(date +'%b %d %H:%M') UTC" \
            --body "$BODY" 2>/dev/null || echo "Could not create issue"
